#!/usr/bin/env python3
import requests, time, uuid, sys; test_id=f"failover_{int(time.time())}_{uuid.uuid4().hex[:8]}"; collection_name=f"AUTOTEST_failover_{test_id}"; created_collections=set(); print(f"ğŸ”„ Write Failover Test - Session: {test_id}"); print("=" * 50); r=requests.get("https://chroma-load-balancer.onrender.com/status", timeout=30); instances=r.json().get("instances", []); primary_healthy=any(i.get("name")=="primary" and i.get("healthy") for i in instances); replica_healthy=any(i.get("name")=="replica" and i.get("healthy") for i in instances); print(f"Instance Status: Primary {"âœ…" if primary_healthy else "âŒ"}, Replica {"âœ…" if replica_healthy else "âŒ"}"); print(f"Failover scenario: {not primary_healthy and replica_healthy}"); payload={"name": collection_name, "metadata": {"test": "write_failover_bulletproof", "session": test_id}}; r=requests.post("https://chroma-load-balancer.onrender.com/api/v2/tenants/default_tenant/databases/default_database/collections", json=payload, timeout=30); print(f"âœ… Collection creation: SUCCESS ({r.status_code})" if r.status_code in [200,201] else f"âŒ Collection creation: FAILED ({r.status_code})"); print("ğŸ‰ WRITE FAILOVER WORKING!" if not primary_healthy and r.status_code in [200,201] else ""); created_collections.add(collection_name) if r.status_code in [200,201] else None; r=requests.delete(f"https://chroma-load-balancer.onrender.com/api/v2/tenants/default_tenant/databases/default_database/collections/{collection_name}", timeout=30); print(f"âœ… Collection deletion: SUCCESS ({r.status_code})" if r.status_code in [200,404] else f"âŒ Collection deletion: FAILED ({r.status_code})"); print("ğŸ‰ DELETE FAILOVER WORKING!" if not primary_healthy and r.status_code in [200,404] else ""); created_collections.discard(collection_name) if r.status_code in [200,404] else None; print("\nâœ… No emergency cleanup needed - all test data properly removed" if not created_collections else f"\nğŸ§¹ Emergency cleanup: {len(created_collections)} collections"); print("\nğŸ Write Failover Test Complete! âœ… Write failover working correctly")
