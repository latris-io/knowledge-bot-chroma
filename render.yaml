# Deploy directly to Knowledge Bot project
# Add this at the top of render.yaml to specify the project
project: knowledge-bot

services:
  # Primary ChromaDB instance
  - type: web
    name: chroma-primary
    env: docker
    dockerfilePath: ./Dockerfile
    region: oregon
    plan: starter
    disk:
      name: chroma-primary-data
      mountPath: /chroma/chroma
      sizeGB: 10
    healthCheckPath: /api/v2/version
    envVars:
      - key: CHROMA_SERVER_HOST
        value: 0.0.0.0
      - key: CHROMA_SERVER_HTTP_PORT
        value: 8000
      - key: CHROMA_PERSIST_DIRECTORY
        value: /chroma/chroma
      - key: INSTANCE_ROLE
        value: primary
      - key: INSTANCE_PRIORITY
        value: 100

  # Replica ChromaDB instance
  - type: web
    name: chroma-replica
    env: docker
    dockerfilePath: ./Dockerfile
    region: oregon
    plan: starter
    disk:
      name: chroma-replica-data
      mountPath: /chroma/chroma
      sizeGB: 10
    healthCheckPath: /api/v2/version
    envVars:
      - key: CHROMA_SERVER_HOST
        value: 0.0.0.0
      - key: CHROMA_SERVER_HTTP_PORT
        value: 8000
      - key: CHROMA_PERSIST_DIRECTORY
        value: /chroma/chroma
      - key: INSTANCE_ROLE
        value: replica
      - key: INSTANCE_PRIORITY
        value: 80

  # True Load Balancer with multiple strategies
  - type: web
    name: chroma-load-balancer
    env: docker
    dockerfilePath: ./Dockerfile.loadbalancer
    region: oregon
    plan: starter
    healthCheckPath: /health
    envVars:
      - key: PRIMARY_URL
        value: https://chroma-primary.onrender.com
      - key: REPLICA_URL
        value: https://chroma-replica.onrender.com
      - key: CHECK_INTERVAL
        value: 30
      - key: FAILURE_THRESHOLD
        value: 3
      - key: LOAD_BALANCE_STRATEGY
        value: write_primary  # Options: round_robin, random, priority, write_primary
      - key: SLACK_WEBHOOK_URL
        sync: false

  # Background worker for health monitoring and failover
  - type: worker
    name: chroma-monitor
    env: docker
    dockerfilePath: ./Dockerfile.monitor
    region: oregon
    plan: starter
    envVars:
      - key: PRIMARY_URL
        value: https://chroma-primary.onrender.com
      - key: REPLICA_URL
        value: https://chroma-replica.onrender.com
      - key: LOAD_BALANCER_URL
        value: https://chroma-load-balancer.onrender.com
      - key: CHECK_INTERVAL
        value: 30
      - key: FAILURE_THRESHOLD
        value: 3
# API key is optional - only needed for advanced service management
      # - key: RENDER_API_KEY
      #   sync: false
      - key: SLACK_WEBHOOK_URL
        sync: false
      - key: DATABASE_URL
        fromDatabase:
          name: chroma-metadata
          property: connectionString

  # Data synchronization worker (with distributed mode support)
  - type: worker
    name: chroma-sync
    env: docker
    dockerfilePath: ./Dockerfile.sync
    region: oregon
    plan: starter
    envVars:
      - key: PRIMARY_URL
        value: https://chroma-primary.onrender.com
      - key: REPLICA_URL
        value: https://chroma-replica.onrender.com
      - key: DATABASE_URL
        fromDatabase:
          name: chroma-metadata
          property: connectionString
      - key: SYNC_INTERVAL
        value: 300  # 5 minutes
      - key: MAX_MEMORY_MB
        value: "400"
      - key: MAX_WORKERS
        value: "2"
      # Distributed Sync Configuration (Set SYNC_DISTRIBUTED=true to enable)
      - key: SYNC_DISTRIBUTED
        value: "false"  # Change to "true" to enable distributed mode
      - key: SYNC_COORDINATOR
        value: "false"  # Set to "true" for coordinator instance only
      - key: SYNC_CHUNK_SIZE
        value: "1000"   # Documents per chunk in distributed mode

databases:
  # Optional: PostgreSQL for storing failover state and metrics
  - name: chroma-metadata
    databaseName: chroma_ha
    user: chroma_user
    region: oregon
    plan: free 